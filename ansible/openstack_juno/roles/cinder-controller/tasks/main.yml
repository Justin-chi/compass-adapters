---
- name: install cinder packages
  apt: name={{ item }} state=present force=yes
  with_items:
    - cinder-api
    - cinder-scheduler
    - python-cinderclient

- name: upload cinder conf
  template: src=cinder.conf dest=/etc/cinder/cinder.conf
  notify:
    - restart cinder-scheduler
    - restart cinder-api

- name: sync cinder db
  shell: su -s /bin/sh -c "cinder-manage db sync" cinder && cinder
  when: "HA_CLUSTER is defined and HA_CLUSTER[inventory_hostname] == None"
  register: result
  until: result.rc == 0
  retries: 5
  delay: 3
  notify:
    - restart cinder-scheduler
    - restart cinder-api

- meta: flush_handlers

- name: upload cinder keystone register script
  template: src=cinder_init.sh dest=/opt/cinder_init.sh mode=0744

- name: run cinder register script
  shell: for i in {0..5}; do /opt/cinder_init.sh && touch cinder_init_complete; if [ $? != 0 ]; then sleep 5; else break; fi; done
  when: "HA_CLUSTER is defined and HA_CLUSTER[inventory_hostname] == None"
  args:
    creates: cinder_init_complete
