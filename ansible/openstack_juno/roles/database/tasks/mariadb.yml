---
- name: install python-mysqldb
  apt: name={{ item }} state=present force=yes
  with_items:
      - libaio1
      - libssl0.9.8
      - mysql-client-5.5
      - python-mysqldb

- name: download mariadb and galera deb package
  get_url: url={{ item.url }} dest=/opt/{{ item.filename }}
  with_items:
    - { url:  "{{ MARIADB_URL }}", filename: "{{ MARIADB }}" }
    - { url:  "{{ GALERA_URL }}", filename: "{{ GALERA }}" }

- name: install mariadb  and galera packages
  command: dpkg -i deb=/opt/{{ item }}
  with_items:
    - "{{ MARIADB }}"
    - "{{ GALERA }}"

- name: update mariadb my.cnf
  copy: src=my.cnf dest=/etc/mysql/my.cnf backup=yes

- name: update galera wsrep.cnf
  template: src=wsrep.cnf dest=/etc/mysql/conf.d/wsrep.cnf

- name: update wsrep_cluster_address
  lineinfile: dest=/etc/mysql/conf.d/wsrep.cnf state=present regexp="^#wsrep_cluster_address=*"
              line="wsrep_cluster_address=gcomm://{{ WSREP_BKP[inventory_hostname] }}"

- name: manually restart mysql server
  service: name=mysql
           state=restarted

- name: create wsrep sst local user
  mysql_user: name={{ WSREP_SST_USER }}
              password={{ WSREP_SST_PASS }}
              priv=ALL.*:ALL
              state=present

- name: create wsrep sst local user
  mysql_user: name={{ WSREP_SST_USER }}
              host=%
              password={{ WSREP_SST_PASS }}
              priv=ALL.*:ALL
              state=present
